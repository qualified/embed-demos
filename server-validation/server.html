<!DOCTYPE html>
<html>
<body>
<div id=qualified-embed></div>
<script src="https://www.qualified.io/embed.js"></script>
<script>

// This script is not visible to the client and is invoked
// programmatically by Playwright to validate the
// candidate's solution securely on the server.
//
// runEmbed is the entry point, allowing your request
// handler to specify the configuration and candidate
// solution for a run.

window.runEmbed = async ({
  fileContents,
  embedOptions,
  editorConfig,
}) => {
  const managerReady = new Promise(resolve => {
    const manager = window.QualifiedEmbed.init({
      options: embedOptions,
      onLoaded() {
        resolve({manager, editor});
      },
    });
    const editor = manager.createEditor({
      node: document.querySelector("#qualified-embed"),
      ...editorConfig,
    });
  });
  const {editor} = await managerReady;
  await editor.setFileContents(fileContents);

  // delay and retry to avoid Error: [RunnerFrame] Receipt Timed out
  await new Promise(r => setTimeout(r, 100));

  for (let i = 0; i < 5; i++) {
    try {
      return await editor.attempt();
    } catch (err) {}
  }

  throw Error("Unable to run code");
};

const testRunEmbed = () => {
  const code = `const sayHello = name =>
    name ? \`Hello, \${name}!\` : "Hello there!";
  `;
  
  window
    .runEmbed({
      embedOptions: {
        embedClientKey: "g39RsSfAYEkyRG8ZYjxrpT9c/XqnfQpN",
        language: "javascript",
      },
      editorConfig: {
        challengeId: "5f029b271dbad30012978cd5",
      },
      fileContents: {code},
    })
    .then(res => console.log(res))
    .catch(err => console.error(err));
};
// testRunEmbed(); // optionally test runEmbed

</script>
</body>
</html>
